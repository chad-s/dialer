/* Author: Chad A. Sutfin
 * Target: ATMega328p
 *
 * These are functions to init and generate sine waves.
 */

#include "dtmf_generator.h"
#include <avr/io.h>

uint16_t index_hi = 0;
uint16_t index_lo = 0;
uint16_t offset_hi = 0;
uint16_t offset_lo = 0;

const uint8_t wave_table[256] = {
   0x40, 0x41, 0x43, 0x44, 0x46, 0x47, 0x49, 0x4A, 0x4C, 0x4D, 0x4F, 0x50,
   0x52, 0x53, 0x55, 0x56, 0x58, 0x59, 0x5B, 0x5C, 0x5D, 0x5F, 0x60, 0x61,
   0x63, 0x64, 0x65, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6F, 0x70,
   0x71, 0x72, 0x73, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x78, 0x79, 0x7A,
   0x7A, 0x7B, 0x7B, 0x7C, 0x7C, 0x7D, 0x7D, 0x7D, 0x7E, 0x7E, 0x7E, 0x7F,
   0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7E, 0x7E,
   0x7E, 0x7D, 0x7D, 0x7D, 0x7C, 0x7C, 0x7B, 0x7B, 0x7A, 0x7A, 0x79, 0x78,
   0x78, 0x77, 0x76, 0x75, 0x74, 0x73, 0x73, 0x72, 0x71, 0x70, 0x6F, 0x6D,
   0x6C, 0x6B, 0x6A, 0x69, 0x68, 0x67, 0x65, 0x64, 0x63, 0x61, 0x60, 0x5F,
   0x5D, 0x5C, 0x5B, 0x59, 0x58, 0x56, 0x55, 0x53, 0x52, 0x50, 0x4F, 0x4D,
   0x4C, 0x4A, 0x49, 0x47, 0x46, 0x44, 0x43, 0x41, 0x40, 0x3E, 0x3C, 0x3B,
   0x39, 0x38, 0x36, 0x35, 0x33, 0x32, 0x30, 0x2F, 0x2D, 0x2C, 0x2A, 0x29,
   0x27, 0x26, 0x24, 0x23, 0x22, 0x20, 0x1F, 0x1E, 0x1C, 0x1B, 0x1A, 0x18,
   0x17, 0x16, 0x15, 0x14, 0x13, 0x12, 0x10, 0x0F, 0x0E, 0x0D, 0x0C, 0x0C,
   0x0B, 0x0A, 0x09, 0x08, 0x07, 0x07, 0x06, 0x05, 0x05, 0x04, 0x04, 0x03,
   0x03, 0x02, 0x02, 0x02, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02,
   0x03, 0x03, 0x04, 0x04, 0x05, 0x05, 0x06, 0x07, 0x07, 0x08, 0x09, 0x0A,
   0x0B, 0x0C, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x12, 0x13, 0x14, 0x15, 0x16,
   0x17, 0x18, 0x1A, 0x1B, 0x1C, 0x1E, 0x1F, 0x20, 0x22, 0x23, 0x24, 0x26,
   0x27, 0x29, 0x2A, 0x2C, 0x2D, 0x2F, 0x30, 0x32, 0x33, 0x35, 0x36, 0x38,
   0x39, 0x3B, 0x3C, 0x3E};

void dtmf_init() {
   // Timer/Counter 0 initialization
   // Clock source: System Clock
   // Clock value: 2000.000 kHz
   // Mode: Fast PWM top=0xFF
   // OC0A output: Non-Inverted PWM
   // OC0B output: Disconnected
   // Timer Period: 0.128 ms
   // Output Pulse(s):
   // OC0A Period: 0.128 ms Width: 0 us
   TCCR0A=(1<<COM0A1) | (0<<COM0A0) | (0<<COM0B1) | (0<<COM0B0) | (1<<WGM01) | (1<<WGM00);
   TCCR0B=(0<<WGM02) | (0<<CS02) | (0<<CS01) | (1<<CS00);
   TCNT0=0x00;
   OCR0A=0x00;
   OCR0B=0x00;

   // Timer/Counter 0 Interrupt(s) initialization
   TIMSK0=(0<<OCIE0B) | (0<<OCIE0A) | (1<<TOIE0);
}


void dtmf_increment() {
   index_hi = (index_hi + offset_hi) % 4096;
   index_lo = (index_lo + offset_lo) % 4096;

   OCR0A = wave_table[(index_hi / 16)] + wave_table[(index_lo / 16)] * 3 / 4;
}

void  dtmf_set_tone(uint8_t tone) {
   dtmf_set_offsets(tone);
}

void  dtmf_stop(void) {
   TCCR0B=(0<<WGM02) | (0<<CS02) | (0<<CS01) | (0<<CS00);
}

void  dtmf_start(void) {
   TCCR0B=(0<<WGM02) | (0<<CS02) | (0<<CS01) | (1<<CS00);
}


void dtmf_set_offsets(uint8_t tone) {
   
   switch (tone) {
      case 0x00 : offset_hi = 0x5F; offset_lo = 0x43; break;
      case 0x01 : offset_hi = 0x56; offset_lo = 0x32; break; 
      case 0x02 : offset_hi = 0x5F; offset_lo = 0x32; break; 
      case 0x03 : offset_hi = 0x69; offset_lo = 0x32; break; 
      case 0x04 : offset_hi = 0x56; offset_lo = 0x37; break; 
      case 0x05 : offset_hi = 0x5F; offset_lo = 0x37; break; 
      case 0x06 : offset_hi = 0x69; offset_lo = 0x37; break; 
      case 0x07 : offset_hi = 0x56; offset_lo = 0x3D; break; 
      case 0x08 : offset_hi = 0x5F; offset_lo = 0x3D; break; 
      case 0x09 : offset_hi = 0x69; offset_lo = 0x3D; break; 
      case 0x0A : offset_hi = 0x74; offset_lo = 0x32; break; 
      case 0x0B : offset_hi = 0x74; offset_lo = 0x37; break; 
      case 0x0C : offset_hi = 0x74; offset_lo = 0x3D; break; 
      case 0x0D : offset_hi = 0x74; offset_lo = 0x43; break; 
      case 0x0E : offset_hi = 0x56; offset_lo = 0x43; break; 
      case 0x0F : offset_hi = 0x69; offset_lo = 0x43; break;
   }

}
